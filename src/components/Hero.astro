---
interface Props {
  title: string;
  subtitle?: string;
  cover?: string;
}
const { title, subtitle = "", cover = "/1.jpg" } = Astro.props;
---

<div id="hero">
  <div class="centro">
    <div class="mainimage">
      <img src="/main-hero-ess-100.webp" alt="Ess Ski School 100 ans" />
      <div class="bg-mainimage"></div>
    </div>
    <div class="txt">
      <div class="conte">
        <h1>100 <span>ANS</span><br /></h1>
        <h2>{title}</h2>
        <p>{subtitle}</p>
      </div>
    </div>
  </div>
</div>

<style lang="scss">
  @use "../styles/variables.scss" as *;
  #hero {
    position: relative;
    width: 100%;
    height: 100vh;
    display: grid;
    grid-template-columns: 1fr 1.5fr 10%;
    place-items: center;
    
    &::after{
      content: "";
      grid-column: 2 / -1;
      grid-row: 1 / -1;
      width: 100%;
      height: 100%;
      background: url("/bg-hero-mountain-ess-100.webp") no-repeat right top/cover;
      z-index: -1;
    }

    h1 {
      text-align: center;
      font-size: clamp(1.2rem, 5vw, 7vw);
      font-weight: 600;
      color: $dorado;
      margin-bottom: 0.5rem;
      span {
        color: $rojo;
      }
    }
  }

  .centro {
    grid-column: 1 / -1;
    grid-row: 1 / -1;
    display: grid;
    grid-template-columns: 1fr 1.5fr 10%;
    grid-template-rows: 20% repeat(2, 1fr);
    height: 26dvw;

    .mainimage {
      grid-column: 1 / span 1;
      grid-row: 1 / -1;
      display: grid;
      grid-template-columns: subgrid;
      grid-template-rows: subgrid;

      img {
        grid-column: 1 / span 1;
        grid-row: 1/ -1;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: left center;
        order: 1;
        grid-template-rows: subgrid;
      }
      .bg-mainimage {
        grid-column: 1 / span 1;
        grid-row: 2/ -1;
        width: 100%;
        height: 100%;
        background: #e7f3fc;
        background: linear-gradient(
          316deg,
          rgba($fondo, 1) 0%,
          rgba($gris-fondo, 1) 100%
        );
      }
    }
    .txt {
      grid-column: 2 / span 1;
      grid-row: 2 / -1;
      background: rgba($fondo, .6);
      display: flex;
      place-items: center;
      backdrop-filter: blur(8px);
      .conte {
        grid-row: 2 / span 1;
        text-align: center;
        order: 2;
      }
    }
  }

  video {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
    // border-radius: 10px;
  }
</style>

<script>
  import { gsap } from "gsap";
  import { SplitText } from "gsap/SplitText";

  // Definir la interfaz para la posición del loader
  interface LoaderPosition {
    fontSize: string;
  }

  // Registrar el plugin inmediatamente
  gsap.registerPlugin(SplitText);

  // Esperar a que el DOM esté listo
  document.addEventListener("DOMContentLoaded", () => {
    if (!gsap || !SplitText) {
      console.error("GSAP o SplitText no están disponibles");
      return;
    }

    gsap.registerPlugin(SplitText);

    // Función para inicializar la animación del Hero
    function initHeroAnimation(fromLoader: LoaderPosition | null = null) {
      const heroNumber = document.querySelector("#hero h1");
      if (!heroNumber || !(heroNumber instanceof HTMLElement)) {
        // console.error('No se encontró el elemento del número');
        return;
      }

      // console.log("Iniciando animación del hero");

      // Hacer visible el número
      heroNumber.style.visibility = "visible";
      heroNumber.style.opacity = "1";

      // Crear el split text
      const splitNumber = new SplitText(heroNumber, {
        type: "chars",
        position: "relative",
      });

      // Animación inicial
      if (fromLoader) {
        console.log("Animando desde el loader", fromLoader);

        // Posicionar cada carácter en el centro de la pantalla
        splitNumber.chars.forEach((char) => {
          gsap.set(char, {
            // position: 'fixed',
            left: "0%",
            top: "0%",
            //   fontSize: fromLoader.fontSize,
            opacity: 0,
            x: "0%",
            y: "-50%",
            transformOrigin: "center center",
          });
        });

        // Timeline para la animación
        const tl = gsap.timeline();

        tl.to(splitNumber.chars, {
          position: "relative",
          left: "0",
          top: "0",
          // fontSize: "10rem",
          x: 0,
          y: 0,
          opacity: 1,
          duration: 2,
          ease: "elastic.out(1, 0.75)",
          stagger: {
            amount: 0.5,
            // from: 'left'
          },
        }).from(
          "#hero h2, #hero p",
          {
            opacity: 0,
            y: 30,
            duration: 0.8,
            stagger: 0.3,
          },
          "-=0.5"
        );
      } else {
        console.log("Animación fallback");

        // Animación fallback
        const tl = gsap.timeline();

        tl.from(splitNumber.chars, {
          y: 100,
          opacity: 0,
          duration: 1,
          ease: "power3.out",
          stagger: 0.08,
        }).from(
          "#hero h1 br, #hero p",
          {
            opacity: 0,
            y: 30,
            duration: 0.8,
            stagger: 0.1,
          },
          "-=0.5"
        );
      }
    }

    // Escuchar el evento del loader
    window.addEventListener("loaderComplete", (e) => {
      // console.log('Evento loaderComplete recibido', e);
      const customEvent = e as any;
      if (customEvent.detail) {
        // console.log('Detalle del evento:', customEvent.detail);
        initHeroAnimation(customEvent.detail);
      }
    });

    // Iniciar animación si no hay loader
    if (
      document.readyState === "complete" &&
      !document.querySelector(".loader-wrapper")
    ) {
      console.log("Iniciando animación sin loader");
      initHeroAnimation();
    }
  });
</script>

---
import { Icon } from "astro-icon/components";
import Button from "./Button.astro";
---

<div id="contact">
    <div id="datos">
        <ul>
            <li>
                <a href="tel:+41274811480">0041 27 481 14 80</a>
            </li>
            <li>
                <a href="mailto:info@esscrans-montana.ch"
                    >info@esscrans-montana.ch</a
                >
            </li>
            <li>
                <a
                    href="https://maps.app.goo.gl/9t4b8aLG7ZPbnrqX7"
                    target="_blank"
                >
                    École suisse de ski Crans-MontanaRoute des Arolles 2CH-3963
                    Crans-Montana
                </a>
            </li>
            <li>
                <h4>Heures d'ouverture</h4>
                <p>Lundi - Vendredi</p>
                <p>09.00 - 12.00 / 14.00 - 17.00</p>
            </li>
            <li>
                <div class="social">
                    <span>Suivez-nous</span>
                    <ol>
                        <li>
                            <a href="facebook" target="_blank"
                                ><Icon name="mdi:facebook" /></a
                            >
                        </li>
                        <li>
                            <a href="instagram" target="_blank"
                                ><Icon name="mdi:instagram" /></a
                            >
                        </li>
                        <li>
                            <a href="youtube" target="_blank"
                                ><Icon name="mdi:youtube" /></a
                            >
                        </li>
                    </ol>
                </div>
            </li>
        </ul>
    </div>

    <!-- ---------------------------------------------------------------------------------------- -->
    <div id="form">
        <form id="contact-form">
            <label for="name"
                >Nom
                <input
                    type="text"
                    name="name"
                    id="name"
                    placeholder="Nom Complet"
                    required
                />
            </label>
            <label for="email"
                >Email
                <input
                    type="email"
                    name="email"
                    id="email"
                    placeholder="Adresse Email"
                    required
                />
            </label>
            <label for="message"
                >Message
                <textarea
                    name="message"
                    id="message"
                    placeholder="Votre message"
                    required></textarea>
            </label>
            <Button type="submit" text="Envoyer" icon="mdi:send" />
        </form>
    </div>
    <div class="mensaje"></div>
</div>

<style lang="scss">
    @use "../styles/variables.scss" as *;
    #contact {
        display: flex;
        gap: 2rem;
        position: relative;
        padding: $margen;
        background: #ffffff;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 1) 0%,
            rgba($fondo, 1) 100%
        );

        // Borde superior con corte diagonal
        &::before {
            content: "";
            position: absolute;
            top: 0;
            left: $margen;
            right: $margen;
            height: 1px;
            background-color: rgba($gris, 0.4);
        }

        // Borde inferior con corte diagonal
        &::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: $margen;
            right: $margen;
            height: 1px;
            background-color: rgba($gris, 0.4);
        }
        #datos {
            flex: 1 0 50%;
            li {
                padding: 0.8rem 0;
            }
            ol {
                display: flex;
                gap: 0.8rem;
                a {
                    font-size: 1.6rem;
                    color: $dorado;
                }
            }
            span {
                color: $rojo;
                font-size: 0.8rem;
            }
            a {
                text-decoration: underline;
            }
        }
        #form {
            flex: 1 0 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        form {
            display: flex;
            flex-wrap: wrap;
        }
        label {
            flex: 1 0 50%;
            display: flex;
            flex-direction: column;
            margin-top: 0.8rem;
            padding: 0.7rem 0.3rem;
        }
        input {
            padding: 0.8rem;
            border: none;
            background: rgba($dorado, 0.2);
            margin-top: 0.7rem;
            @extend .sombra;
        }
        textarea {
            flex: 1 1 100%;
            padding: 0.8rem;
            border: none;
            background: rgba($dorado, 0.2);
            margin-top: 0.7rem;
            @extend .sombra;
        }
        button {
            margin-top: $margen-cel;
            padding: 0.7rem;
            flex: 1 0 70%;
            align-items: right;
        }

        .mensaje {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2rem 3rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 90%;

            &.show {
                opacity: 1;
                visibility: visible;
            }

            &.success {
                background: $dorado;
                color: $gris;
            }

            &.error {
                background: $gris;
                color: white;
            }
        }

        @include cel {
            padding: 3rem;
            flex-wrap: wrap;
            #datos,
            #form {
                flex: 1 0 100%;
            }

            &::before {
                left: 3rem;
                right: 3rem;
            }

            // Borde inferior con corte diagonal
            &::after {
                left: 3rem;
                right: 3rem;
            }
        }
    }
</style>

<script>
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const mensajeDiv = document.querySelector(".mensaje") as HTMLElement;

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Obtener los datos del formulario
            const formData = new FormData(form);

            // Deshabilitar el botón de envío para evitar múltiples envíos
            const submitButton = form.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement;
            const originalButtonText = submitButton?.textContent || "Send";

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = "Envoi...";
            }

            try {
                // Enviar el formulario
                const response = await fetch("/100/contact.php", {
                    method: "POST",
                    body: formData,
                });

                const data = await response.json();

                // Mostrar mensaje
                if (mensajeDiv) {
                    mensajeDiv.textContent = data.message;
                    mensajeDiv.className =
                        "mensaje show " + (data.success ? "success" : "error");

                    // Ocultar mensaje después de 5 segundos
                    setTimeout(() => {
                        mensajeDiv.classList.remove("show");
                    }, 5000);
                }

                // Si fue exitoso, limpiar el formulario
                if (data.success) {
                    form.reset();
                }
            } catch (error) {
                console.error("Error:", error);

                if (mensajeDiv) {
                    mensajeDiv.textContent =
                        "Erreur lors de l'envoi du message. Veuillez réessayer.";
                    mensajeDiv.className = "mensaje show error";

                    setTimeout(() => {
                        mensajeDiv.classList.remove("show");
                    }, 5000);
                }
            } finally {
                // Rehabilitar el botón
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            }
        });
    }
</script>
